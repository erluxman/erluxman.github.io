{"componentChunkName":"component---src-templates-blog-post-js","path":"/ja/algebraic-effects-for-the-rest-of-us/","result":{"data":{"site":{"siteMetadata":{"title":"Overreacted","author":"Dan Abramov"}},"markdownRemark":{"id":"55193cfc-3328-5def-9c3e-a2a50ff7b55a","html":"<p>Algebraic Effects について聞いたことはあるでしょうか？</p>\n<p>最初に私がこの概念が何なのか、なぜ気にする必要があるのかを理解しようと試みたときは全然ダメでした。<a href=\"https://www.eff-lang.org/handlers-tutorial.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">いくつか</a>の<a href=\"https://www.microsoft.com/en-us/research/wp-content/uploads/2016/08/algeff-tr-2016-v2.pdf\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">PDF</a> を見つけましたが、余計にわからなくなりました（リンク先は学術的な PDF で、読んでで眠くなりました）。</p>\n<p>しかし同僚の Sebastian は<a href=\"https://mobile.twitter.com/sebmarkbage/status/763792452289343490\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ずっと</a>この<a href=\"https://mobile.twitter.com/sebmarkbage/status/776883429400915968\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">概念</a>について<a href=\"https://mobile.twitter.com/sebmarkbage/status/776840575207116800\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">言及</a>を<a href=\"https://mobile.twitter.com/sebmarkbage/status/969279885276454912\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">し続けていました</a>。これが私たちが React の中でやってることのメンタルモデルなんですよと（Sebastian は React チームで働いていて、これまで相当な数のアイデアを思いついています。それには hooks や Suspense といったものも含まれます）。気づいたら React チームではお決まりのジョークとして、しばしば会話の最後をこんな感じで締めるようになりました。</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/5fb19385d24afb94180b6ba9aeb2b8d4/066f9/effects.jpg\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 400px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 87.16216216216216%; position: relative; bottom: 0; left: 0; background-image: url('data:image/jpeg;base64,/9j/2wBDABALDA4MChAODQ4SERATGCgaGBYWGDEjJR0oOjM9PDkzODdASFxOQERXRTc4UG1RV19iZ2hnPk1xeXBkeFxlZ2P/2wBDARESEhgVGC8aGi9jQjhCY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2NjY2P/wgARCAARABQDASIAAhEBAxEB/8QAGAABAQEBAQAAAAAAAAAAAAAAAAQDBQL/xAAWAQEBAQAAAAAAAAAAAAAAAAACAwD/2gAMAwEAAhADEAAAAeVtVlNwrBdforHjhb//xAAdEAACAgEFAAAAAAAAAAAAAAABAgADERMhIjIz/9oACAEBAAEFAgu9yaYxCoK2K7NxEr85Z3//xAAWEQADAAAAAAAAAAAAAAAAAAAAEBH/2gAIAQMBAT8BI//EABkRAAEFAAAAAAAAAAAAAAAAAAEAEBESUf/aAAgBAgEBPwESrHH/AP/EABsQAAMAAgMAAAAAAAAAAAAAAAABEQIhEBJh/9oACAEBAAY/AhbvC6pssbnhMtMRkM//xAAcEAABBQEBAQAAAAAAAAAAAAABABARIUExUXH/2gAIAQEAAT8h6MQS7j0Q0nDe0EQwmNK0gPhDXflh/9oADAMBAAIAAwAAABDcL/z/xAAZEQABBQAAAAAAAAAAAAAAAAARAAEQQVH/2gAIAQMBAT8QLWg2f//EABkRAQACAwAAAAAAAAAAAAAAAAEAECExUf/aAAgBAgEBPxBLKR7Iar//xAAeEAEAAgIBBQAAAAAAAAAAAAABABEhQaExUXGx8f/aAAgBAQABPxBLMvoqCCrF614lnURBHN9agjMlNH1m5Zjzl2rB2nGfcZefP//Z'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"\"Algebraic Effects\" caption on the \"Ancient Aliens\" guy meme\"\n        title=\"\"\n        src=\"/static/5fb19385d24afb94180b6ba9aeb2b8d4/066f9/effects.jpg\"\n        srcset=\"/static/5fb19385d24afb94180b6ba9aeb2b8d4/a80bd/effects.jpg 148w,\n/static/5fb19385d24afb94180b6ba9aeb2b8d4/1c91a/effects.jpg 295w,\n/static/5fb19385d24afb94180b6ba9aeb2b8d4/066f9/effects.jpg 400w\"\n        sizes=\"(max-width: 400px) 100vw, 400px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<p>次第に、Algebraic Effects というのはなかなかイカした概念で、例の PDF から感じるような怖いものではないことがわかりました。<strong>もしあなたが単に React を使っているだけなら、知らないといけないことはありません — でも私がそうだったように、興味が湧いてきたならこのまま読み続けましょう。</strong></p>\n<p><em>（免責事項: 私はプログラミング言語の研究者ではなく、そのため一部めちゃくちゃな説明があるかもしれません。この分野は素人なので、指摘は歓迎します！）</em></p>\n<h3 id=\"まだプロダクションでは使えませんからね\"><a href=\"#%E3%81%BE%E3%81%A0%E3%83%97%E3%83%AD%E3%83%80%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%A7%E3%81%AF%E4%BD%BF%E3%81%88%E3%81%BE%E3%81%9B%E3%82%93%E3%81%8B%E3%82%89%E3%81%AD\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>まだプロダクションでは使えませんからね</h3>\n<p><em>Algebraic Effects</em> というのは研究用プログラミング言語が持っている機能のひとつです。ということはつまり、<strong>この機能は <code class=\"language-text\">if</code> 文 とか関数とか <code class=\"language-text\">async / await</code> などとは違い、実際のプロダクションコードで使ってることはおそらくないということです</strong>。一部の<a href=\"https://www.eff-lang.org/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ごく少数</a>の<a href=\"https://www.microsoft.com/en-us/research/project/koka/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">言語</a>がそれをサポートしており、当の言語自体この概念の探求のために作られたものだったりします。プロダクションに取り入れようという動きは OCaml には見られるようですが……まだまだ<a href=\"https://github.com/ocaml-multicore/ocaml-multicore/wiki\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">進行中</a>といった具合です。要はまだまだ<a href=\"https://www.youtube.com/watch?v=otCpCn0l4Wo\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Can’t Touch This</a>という訳です。</p>\n<blockquote>\n<p>追記: 何人かの方から、LISP では<a href=\"#%E3%82%82%E3%81%A3%E3%81%A8%E8%A9%B3%E3%81%97%E3%81%8F%E5%AD%A6%E3%81%B3%E3%81%9F%E3%81%84%E4%BA%BA%E3%81%AF\">似たような仕組みがある</a>と聞きました。なので LISP を使っていればプロダクションで使えるようです。</p>\n</blockquote>\n<h3 id=\"なら何故気にするのか？\"><a href=\"#%E3%81%AA%E3%82%89%E4%BD%95%E6%95%85%E6%B0%97%E3%81%AB%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B%EF%BC%9F\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>なら何故気にするのか？</h3>\n<p>もしあなたが <code class=\"language-text\">goto</code> を使ったコードを書いていて、他の誰かが <code class=\"language-text\">if</code> 文や <code class=\"language-text\">for</code> 文を見せてくれたとしましょう。あるいはコールバック地獄の奥にいる時に誰かが <code class=\"language-text\">async / await</code> を見せてくれたら……最高だと思いませんか？</p>\n<p>まだ主流になるには数年かかるであろうプログラミング上の概念について学ぶのが好きなタイプの人にとっては、Algebraic Effects はそろそろ気になるもののはずです。<em>知っとかないとダメ</em>ってものではないですよ。いってみれば 1999 年に <code class=\"language-text\">async / await</code> について考えるようなものですから。</p>\n<h3 id=\"よし、じゃあ-algebraic-effects-って何なんだい？\"><a href=\"#%E3%82%88%E3%81%97%E3%80%81%E3%81%98%E3%82%83%E3%81%82-algebraic-effects-%E3%81%A3%E3%81%A6%E4%BD%95%E3%81%AA%E3%82%93%E3%81%A0%E3%81%84%EF%BC%9F\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>よし、じゃあ Algebraic Effects って何なんだい？</h3>\n<p>名前は仰々しいですが、概念はシンプルです。あなたが <code class=\"language-text\">try / catch</code> 構文に慣れ親しんでいるなら、すぐに分かるでしょう。</p>\n<p>まず <code class=\"language-text\">try / catch</code> についてまとめてみましょう。何かしら <code class=\"language-text\">throw</code> する関数があるとします。そして当の関数と <code class=\"language-text\">catch</code> 節の間にはいくつもの関数が挟まってるとしましょう。</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> name <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  \t<span class=\"token keyword\">throw</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Error</span><span class=\"token punctuation\">(</span><span class=\"token string\">'A girl has no name'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user1<span class=\"token punctuation\">,</span> user2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  user1<span class=\"token punctuation\">.</span>friendNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span>user2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  user2<span class=\"token punctuation\">.</span>friendNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span>user1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> arya <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> gendry <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'Gendry'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span>arya<span class=\"token punctuation\">,</span> gendry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>err<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Oops, that didn't work out: \"</span><span class=\"token punctuation\">,</span> err<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p><code class=\"language-text\">getName</code> の中で <code class=\"language-text\">throw</code> していますが、そこから <code class=\"language-text\">makeFriends</code> を介して最寄りの <code class=\"language-text\">catch</code> 節に「伝播」していきます。これが <code class=\"language-text\">try / catch</code> の重要な特徴です。<strong>途中にいるものたちはエラーハンドリングのことは気にしなくてよいということです</strong>。</p>\n<p>C 言語のようなエラーコードとは違い、<code class=\"language-text\">try / catch</code> があれば、エラーをわざわざすべての中間層で手で渡してて途中でどっか行った……みたいな心配は不要になります。自動で伝播していくからです。</p>\n<h3 id=\"これが-algebraic-effects-と何の関係があるのか？\"><a href=\"#%E3%81%93%E3%82%8C%E3%81%8C-algebraic-effects-%E3%81%A8%E4%BD%95%E3%81%AE%E9%96%A2%E4%BF%82%E3%81%8C%E3%81%82%E3%82%8B%E3%81%AE%E3%81%8B%EF%BC%9F\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>これが Algebraic Effects と何の関係があるのか？</h3>\n<p>上の例ではひとたびエラーにぶつかると、もう続行できません。一度 <code class=\"language-text\">catch</code> 節に来てしまったら、元のコードをそこから再開というわけには行きません。</p>\n<p>終わりです、もう遅いです。ここでできるのはせいぜい失敗からの復帰を行うことと、よくてリトライを行うかもしれないですが、元いたところに「戻って」違うことをやる魔法のような方法はありません。<strong>しかし、Algebraic Effects があるとそれができるのです</strong>。</p>\n<p>以下は仮想的な JavaScript の文法（面白いのでこれを ES2025 と呼びましょう）で書いた例です。これを使って <code class=\"language-text\">user.name</code> がないところから<em>復帰</em>してみましょう。</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> name <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  \tname <span class=\"token operator\">=</span> perform <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user1<span class=\"token punctuation\">,</span> user2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  user1<span class=\"token punctuation\">.</span>friendNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span>user2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  user2<span class=\"token punctuation\">.</span>friendNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span>user1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> arya <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> gendry <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'Gendry'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span>arya<span class=\"token punctuation\">,</span> gendry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token function\">handle</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">effect</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effect <span class=\"token operator\">===</span> <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  \tresume <span class=\"token keyword\">with</span> <span class=\"token string\">'Arya Stark'</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>（もし 2025 年にインターネットで “ES2025” について調べてここにたどり着いた読者がいたらごめんなさい。もしそれまでに Algebraic Effects が JavaScript に取り込まれていたら喜んで更新しますので！）</em></p>\n<p>ここでは <code class=\"language-text\">throw</code> の代わりに仮想的な <code class=\"language-text\">perform</code> というキーワードを、<code class=\"language-text\">try / catch</code> の代わりに仮想的な <code class=\"language-text\">try / handle</code> を使います。<strong>構文自体は大事ではありません、ひとまず概念の表現として必要なものを考えてみただけです。</strong></p>\n<p>一体何が起きているのでしょう？もっと詳しく見てみましょう。</p>\n<p>私たちは「エラーを投げる」かわりに <em>「エフェクトを引き起こして（perform an effect）」</em>います。ちょうど任意の値が <code class=\"language-text\">throw</code> 可能であるように、<code class=\"language-text\">perform</code> にはどんな値も渡せます。この例では文字列を渡していますが、それはオブジェクトかもしれませんし、他のデータ型でもありうるでしょう。</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> name <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  \tname <span class=\"token operator\">=</span> perform <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>私たちがエラーを <code class=\"language-text\">throw</code> したとき、エンジンはコールスタック上方の一番近い <code class=\"language-text\">try / catch</code> エラーハンドラを見つけます。同様に、我々がエフェクトを <code class=\"language-text\">perform</code> すれば、エンジンはコールスタック上方の一番近い <code class=\"language-text\">try / handle</code> <em>エフェクトハンドラ</em> を見つけに行くでしょう。</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span>arya<span class=\"token punctuation\">,</span> gendry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span> <span class=\"token function\">handle</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">effect</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effect <span class=\"token operator\">===</span> <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \tresume <span class=\"token keyword\">with</span> <span class=\"token string\">'Arya Stark'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>このエフェクトによって、私たちは <code class=\"language-text\">name</code> がなかった時にどうするかを決めることができます。ここで（例外のケースと違った）新しいものがあるとすれば、仮想の <code class=\"language-text\">resume with</code> です。</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span>arya<span class=\"token punctuation\">,</span> gendry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token function\">handle</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">effect</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effect <span class=\"token operator\">===</span> <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  \tresume <span class=\"token keyword\">with</span> <span class=\"token string\">'Arya Stark'</span><span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>これこそ、<code class=\"language-text\">try / catch</code> ではなし得ない部分です。これのおかげで<strong>エフェクトを引き起こした箇所に戻ることができて、さらにハンドラから何かを渡すことができるのです</strong> 🤯</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> name <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  \t<span class=\"token comment\">// 1. We perform an effect here</span></span>  \tname <span class=\"token operator\">=</span> perform <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  \t<span class=\"token comment\">// 4. ...and end up back here (name is now 'Arya Stark')</span></span>  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// ...</span>\n\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span>arya<span class=\"token punctuation\">,</span> gendry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token function\">handle</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">effect</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// 2. We jump to the handler (like try/catch)</span></span>  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effect <span class=\"token operator\">===</span> <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  \t<span class=\"token comment\">// 3. However, we can resume with a value (unlike try/catch!)</span></span>  \tresume <span class=\"token keyword\">with</span> <span class=\"token string\">'Arya Stark'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>ちょっと慣れるのに時間がかかるかもしれませんが、概念的には「再開できる <code class=\"language-text\">try / catch</code>」と考えてそんなに違いません。</p>\n<p>しかし、注意して欲しいのは、<strong>Algebraic Effects そのものは <code class=\"language-text\">try / catch</code> よりもずっと柔軟なもので、エラーから復帰できるというのは数あるユースケースの一つにすぎないということです。</strong>この話から始めたのは、私にとってはこれが腑に落ちるのに最も近道だったと理解したからです。</p>\n<h3 id=\"関数に色はない\"><a href=\"#%E9%96%A2%E6%95%B0%E3%81%AB%E8%89%B2%E3%81%AF%E3%81%AA%E3%81%84\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>関数に色はない</h3>\n<p>Algebraic Effects を使った場合、非同期処理のコードについて、ある興味深い性質が影響してきます。</p>\n<p><code class=\"language-text\">async / await</code> のある言語では、通常<a href=\"https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">関数に「色」がつきます</a>。たとえば、JavaScript では <code class=\"language-text\">getName</code> を非同期にした場合、<code class=\"language-text\">makeFriends</code> やその呼び出し元も <code class=\"language-text\">async</code> に「感染」します。これは<em>一部のコードをある時は同期的、ある時は非同期にしたい</em>というケースで非常に苦しい状況になります。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// If we want to make this async...</span>\n<span class=\"token keyword\">async</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// Then this has to be async too...</span>\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user1<span class=\"token punctuation\">,</span> user2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  user1<span class=\"token punctuation\">.</span>friendNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span>user2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  user2<span class=\"token punctuation\">.</span>friendNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">await</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span>user1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">// And so on...</span></code></pre></div>\n<p>JavaScript のジェネレータも<a href=\"https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Statements/function*\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">同様です</a>。ジェネレータを使うなら、間にいるものたちは皆ジェネレータを考慮に入れなければなりません。</p>\n<p>この話に何の関係があるのでしょうって？</p>\n<p>一旦 <code class=\"language-text\">async / await</code> のことは忘れてさっきの例に戻りましょう。</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> name <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  \tname <span class=\"token operator\">=</span> perform <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user1<span class=\"token punctuation\">,</span> user2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  user1<span class=\"token punctuation\">.</span>friendNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span>user2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  user2<span class=\"token punctuation\">.</span>friendNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span>user1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> arya <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> gendry <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'Gendry'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span>arya<span class=\"token punctuation\">,</span> gendry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token function\">handle</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">effect</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effect <span class=\"token operator\">===</span> <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  \tresume <span class=\"token keyword\">with</span> <span class=\"token string\">'Arya Stark'</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>ここでエフェクトハンドラが「フォールバック先の名前」を同期的には知らなかったらどうなるでしょう？ あるいはデータベースから取りたくなったら？</p>\n<p>もうお分かりでしょう。なんと <code class=\"language-text\">resume with</code> はエフェクトハンドラから非同期に呼んでもよく、その際 <code class=\"language-text\">getName</code> や <code class=\"language-text\">makeFriends</code> に何も手を加える必要はないということです。</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">getName</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> name <span class=\"token operator\">=</span> user<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>name <span class=\"token operator\">===</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \tname <span class=\"token operator\">=</span> perform <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> name<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">user1<span class=\"token punctuation\">,</span> user2</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  user1<span class=\"token punctuation\">.</span>friendNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span>user2<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  user2<span class=\"token punctuation\">.</span>friendNames<span class=\"token punctuation\">.</span><span class=\"token function\">add</span><span class=\"token punctuation\">(</span><span class=\"token function\">getName</span><span class=\"token punctuation\">(</span>user1<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">const</span> arya <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> gendry <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'Gendry'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">makeFriends</span><span class=\"token punctuation\">(</span>arya<span class=\"token punctuation\">,</span> gendry<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token function\">handle</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">effect</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effect <span class=\"token operator\">===</span> <span class=\"token string\">'ask_name'</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  \t<span class=\"token function\">setTimeout</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      resume <span class=\"token keyword\">with</span> <span class=\"token string\">'Arya Stark'</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  \t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>この例では、<code class=\"language-text\">resume with</code> は一秒経つまで呼ばれません。<code class=\"language-text\">resume with</code> とは一度しか呼べないコールバックのようなものと考えられます（あるいはもっと印象的に「ワンショット限定継続」だよと友達に言ってみるのも良いでしょう）。</p>\n<p>これで Algebraic Effects の仕組みがもう少し明確になったはずです。私たちがエラーを <code class=\"language-text\">throw</code> したとき、JavaScript エンジンは「スタックをアンワインドして」、プロセス内のローカル変数は破棄されます。しかし、私たちがエフェクトを <code class=\"language-text\">perform</code> したときは、この仮想のエンジンは関数の残りの部分から<em>コールバックを作成</em>し、<code class=\"language-text\">resume with</code> がそれを呼びます。</p>\n<p><strong>もう一度いいますが、具体的な構文や特殊なキーワードはあくまでもこの記事専用のものです。そこが問題ではなく、重要なのは仕組みの方です。</strong></p>\n<h3 id=\"純粋性についての注意書き\"><a href=\"#%E7%B4%94%E7%B2%8B%E6%80%A7%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6%E3%81%AE%E6%B3%A8%E6%84%8F%E6%9B%B8%E3%81%8D\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>純粋性についての注意書き</h3>\n<p>Algebraic Effects が関数型プログラミングの研究から出てきたものであることは注目に値するでしょう。Algebraic Effects が解決する問題のいくつかは純粋関数型プログラミングに特有のものです。例えば（Haskell のような）任意の副作用を許さ<em>ない</em>ような言語では、モナドのような概念を用いてプログラムと作用（エフェクト）を接続する必要があります。モナドのチュートリアルを読んだことがある人なら、これが考えるのにコツが必要なものであることは知っているでしょう。Algebraic Effects は似たような解決を、より仰々しくない仕方でもたらすものだと言えます。</p>\n<p>そのせいか、私にとって Algebraic Effects についての多くの議論はわかりづらく感じました（私は Haskell とその周辺については<a href=\"/things-i-dont-know-as-of-2018/\">よく知りません</a>）。しかし私の思うところでは、Algebraic Effects は JavaScript のようなちっとも純粋ではない言語にとっても、<strong>非常に強力な形で「何」と「どうやって」を分離する道具になりうるということです。</strong></p>\n<p>おかげでこんな風に、<em>何をしたいのか</em>にフォーカスしたコードが書けます。</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">enumerateFiles</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">dir</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> contents <span class=\"token operator\">=</span> perform <span class=\"token function\">OpenDirectory</span><span class=\"token punctuation\">(</span>dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  perform <span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Enumerating files in '</span><span class=\"token punctuation\">,</span> dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> file <span class=\"token keyword\">of</span> contents<span class=\"token punctuation\">.</span>files<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  \tperform <span class=\"token function\">HandleFile</span><span class=\"token punctuation\">(</span>file<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span>\n<span class=\"gatsby-highlight-code-line\">  perform <span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Enumerating subdirectories in '</span><span class=\"token punctuation\">,</span> dir<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> directory <span class=\"token keyword\">of</span> contents<span class=\"token punctuation\">.</span>dir<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \t<span class=\"token comment\">// We can use recursion or call other functions with effects</span>\n  \t<span class=\"token function\">enumerateFiles</span><span class=\"token punctuation\">(</span>directory<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"gatsby-highlight-code-line\">  perform <span class=\"token function\">Log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Done'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span></code></pre></div>\n<p>そして後々、<em>どうやるか</em>を指定したものでラップできます。</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">let</span> files <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">enumerateFiles</span><span class=\"token punctuation\">(</span><span class=\"token string\">'C:\\\\'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span> <span class=\"token function\">handle</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">effect</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effect <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  \tmyLoggingLibrary<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  \tresume<span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effect <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">OpenDirectory</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  \tmyFileSystemImpl<span class=\"token punctuation\">.</span><span class=\"token function\">openDir</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>dirName<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">contents</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      resume <span class=\"token keyword\">with</span> contents<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  \t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">else</span> <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effect <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">HandleFile</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">    files<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>fileName<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    resume<span class=\"token punctuation\">;</span></span>  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span>\n<span class=\"token comment\">// The `files` array now has all the files</span></code></pre></div>\n<p>これはつまり、その部分だけを切り取ってライブラリにするのも可能ということです。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> withMyLoggingLibrary <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'my-log'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> withMyFileSystem <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'my-fs'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">ourProgram</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">enumerateFiles</span><span class=\"token punctuation\">(</span><span class=\"token string\">'C:\\\\'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">withMyLoggingLibrary</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function\">withMyFileSystem</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">ourProgram</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><code class=\"language-text\">async / await</code> やジェネレータとは異なり、<strong>Algebraic Effects は「間にいる」関数に余分な複雑さを加える必要がありません。</strong>ここでの <code class=\"language-text\">enumerateFiles</code> の呼び出しは、<code class=\"language-text\">ourProgram</code> の中のもっと奥になることもあるでしょう。しかし、perform されるかもしれないエフェクトから見て<em>どこかしら上の方</em>にエフェクトハンドラがある限り、このコードはちゃんと動きます。</p>\n<p>エフェクトハンドラはプログラムのロジックを、具体的なエフェクトの実装から分離します。しかも過度な仰々しさやボイラープレートのコードなしにです。たとえばテスト中には本物のファイルシステムの代わりにフェイクのものを、コンソールに吐き出す代わりにスナップショットログ吐き出すものに挙動を置き換えたいときは、ちゃんとそうすることができます。</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> withFakeFileSystem <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'fake-fs'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">withLogSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">fn</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> logs <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n  \t<span class=\"token function\">fn</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token function\">handle</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">effect</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \t<span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>effect <span class=\"token keyword\">instanceof</span> <span class=\"token class-name\">Log</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  \t  logs<span class=\"token punctuation\">.</span><span class=\"token function\">push</span><span class=\"token punctuation\">(</span>effect<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  \t  resume<span class=\"token punctuation\">;</span>\n  \t<span class=\"token punctuation\">}</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token comment\">// Snapshot emitted logs.</span>\n  <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>logs<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toMatchSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token function\">test</span><span class=\"token punctuation\">(</span><span class=\"token string\">'my program'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> fakeFiles <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span><span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token function\">withFakeFileSystem</span><span class=\"token punctuation\">(</span>fakeFiles<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  \t<span class=\"token function\">withLogSnapshot</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">\t  <span class=\"token function\">ourProgram</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  \t<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>「<a href=\"https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">関数に色がない</a>（つまり間にいるコードはエフェクトのことを知らない）」上に、エフェクトハンドラは組み合わせて利用可能（ネストできる）なので、非常に表現力の豊かな抽象化が作れます。</p>\n<h3 id=\"型について\"><a href=\"#%E5%9E%8B%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>型について</h3>\n<p>Algebraic Effects は静的型付け言語に由来する概念なので、どういう型として表現できるかが多くの議論で中心になります。この点が重要なことに疑いはありませんが、一方で概念を理解するのが困難になります。ですからこの記事では型の話をずっとしてきませんでした。しかし無視できない事実として、ある関数がエフェクトを perform できるという事実は通常、型シグネチャとしてコード化されます。このおかげで、よく分からないエフェクトが発行されて出どころが分からないという状況が防がれるのです。</p>\n<p>厳密には、静的型付け言語における Algebraic Effects は関数に「<a href=\"https://journal.stuffwithstuff.com/2015/02/01/what-color-is-your-function/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">色をつける</a>」といった議論はありえます。というのも、エフェクトは型シグネチャの一種だからです。それはその通りなのですが、新しくエフェクトを追加するために間の関数の型アノテーションを直したとして、それ自体はセマンティクス上の変化ではないはずです。少なくとも <code class=\"language-text\">async</code> を追加したりジェネレータ関数に変更するような話ではありません。また型の推論によってその変更が連鎖していくのも避けられるはずでしょう。特に大きく違うのはエフェクトに対して、何もしない関数やモック実装（たとえば、非同期のエフェクトに対して同期的な呼び出しをする）を与えることで、エフェクトを「封じ込め」られる点です。これにより、必要に応じて外側のコードへの影響を防ぐこともできますし、違ったエフェクトに変えることもできます。</p>\n<h3 id=\"javascript-に-algebraic-effects-を加えるべきか？\"><a href=\"#javascript-%E3%81%AB-algebraic-effects-%E3%82%92%E5%8A%A0%E3%81%88%E3%82%8B%E3%81%B9%E3%81%8D%E3%81%8B%EF%BC%9F\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>JavaScript に Algebraic Effects を加えるべきか？</h3>\n<p>正直わかりません。非常に強力ではありますが、JavaScript にはちょっと<em>パワフルすぎる</em>よね、といった議論も全くありうるでしょう。</p>\n<p>私見では Algebraic Effects がぴったりハマるのは、ミュータブルな変更が通常行われない言語であり、かつ標準ライブラリが完全にエフェクトを擁する作りになっているケースでしょう。もし <code class=\"language-text\">perform Timeout(1000)</code> とか <code class=\"language-text\">perform Fetch(&#39;http://google.com&#39;)</code> とか <code class=\"language-text\">perform ReadFile(&#39;file.txt&#39;)</code> とかが普通の書き方で、言語機能としてエフェクトに対するパターンマッチや静的型検査があるのなら、それは非常にすばらしいプログラミング環境でしょう。</p>\n<p>その言語が JavaScript にコンパイルできるならもっと素晴らしいでしょうね！</p>\n<h3 id=\"ここまでの話が-react-にどう関係するのか？\"><a href=\"#%E3%81%93%E3%81%93%E3%81%BE%E3%81%A7%E3%81%AE%E8%A9%B1%E3%81%8C-react-%E3%81%AB%E3%81%A9%E3%81%86%E9%96%A2%E4%BF%82%E3%81%99%E3%82%8B%E3%81%AE%E3%81%8B%EF%BC%9F\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>ここまでの話が React にどう関係するのか？</h3>\n<p>言うほどではありません。こじつけと言われてもしょうがないとすら思います。</p>\n<p>もしあなたが<a href=\"https://reactjs.org/blog/2018/03/01/sneak-peek-beyond-react-16.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Time Slicing と Suspense についての私の発表</a>を見ていれば、2つ目の話がコンポーネントがキャッシュからデータを引く話に関わってきます。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">MovieDetails</span><span class=\"token punctuation\">(</span><span class=\"token parameter\"><span class=\"token punctuation\">{</span> id <span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// What if it's still being fetched?</span>\n  <span class=\"token keyword\">const</span> movie <span class=\"token operator\">=</span> movieCache<span class=\"token punctuation\">.</span><span class=\"token function\">read</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p><em>（登壇時はちょっと違うAPIを用いていましたが、そこは重要ではありません）</em></p>\n<p>これは React の「Suspense」という、データ取得のユースケース向けに鋭意開発中の機能で作られています。ここでの面白い点はもちろん、<code class=\"language-text\">movieCache</code> にはまだデータがないかもしれない — ない場合ここから下の行には行けないので、<em>どうにか</em>しないといけないというケースです。技術的には、その場合 <code class=\"language-text\">read()</code> は Promise を投げ（そう、Promise が <code class=\"language-text\">throw</code> されるんです！心で理解してください）ます。これによって実行が「一時停止（＝suspend）」されます。React は Promise をキャッチし、投げられた Promise が resolve され次第忘れずにコンポーネントのレンダリングを再開します。</p>\n<p>これは Algebraic Effects それ自体ではありません。この仕掛けはそこから<a href=\"https://mobile.twitter.com/sebmarkbage/status/941214259505119232\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">インスピレーションを得た</a>ものですが、別物です。それでも同じ目的を達成します。つまりコールスタックの下の方にいるコードが、コールスタックの上にいる何か（ここでは React）に後を譲る際、間にいる関数はそのことを知らず、また <code class=\"language-text\">async</code> やジェネレータに「感染」しないようにするということです。もちろん、JavaScript で実行を後から<em>再開</em>することなど本当はできないのですが、React から見ると、Promise が解決した時に再レンダリングをするというのはほぼ同じようなものです。プログラミングモデルが<a href=\"/react-as-a-ui-runtime/#purity\">冪等性を前提にしている</a>からこそできる芸当です！</p>\n<p><a href=\"https://reactjs.org/docs/hooks-intro.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hooks</a>は Algebraic Effects を思い出させるかもしれないもう一つの事例です。多くの人がまず最初に聞く質問としては次のようなことでしょう — <code class=\"language-text\">useState</code> はどうやって自分が参照しているコンポーネントを知ることができるのか？と。</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">LikeButton</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// How does useState know which component it's in?</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isLiked<span class=\"token punctuation\">,</span> setIsLiked<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token boolean\">false</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>その答えは<a href=\"/how-does-setstate-know-what-to-do/\">この記事の終わりの方</a>で既に答えています。React のオブジェクトには「現在のディスパッチャ」とでも呼ぶべき、いま現在使われている実装（たとえば <code class=\"language-text\">react-dom</code>）を指すミュータブルな状態がありますが、それと似たように「現在のコンポーネント」という、ここなら <code class=\"language-text\">LikeButton</code> の内部データ構造を指すプロパティがあるのです。<code class=\"language-text\">useState</code> はそれによってなすべきことを知ります。</p>\n<p>慣れるまではみんな、明白な理由からこれを少し「汚く」感じるようです。共有のミュータブルな状態に依存するなんて「ふさわしくない」と。<em>（ところで、<code class=\"language-text\">try / catch</code> が JavaScript エンジンの中でどう実装されているか考えたことはありますか？）</em></p>\n<p>概念的には、しかし、<code class=\"language-text\">useState()</code> はコンポーネントの実行時に React がハンドリングするような <code class=\"language-text\">perform State()</code> であると考えることができます。これこそが React（あなたのコンポーネントを呼び出すものです）が、なぜ状態を提供できているのかの「説明」になるでしょう（コールスタックの上にあるおかげで、エフェクトハンドラを提供できるからです）。実際、私の見てきた Algebraic Effects のチュートリアルでは、<a href=\"https://github.com/ocamllabs/ocaml-effects-tutorial/#2-effectful-computations-in-a-pure-setting\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">状態の実装</a> は最もよくある事例として紹介されています。</p>\n<p>もちろん改めて言いますが、JavaScript に Algebraic Effects がない以上、これは React の<em>本当の</em>挙動ではありません。その代わり、<code class=\"language-text\">useState</code> の実装が現在のディスパッチャを指すフィールドを持っていたのと同様に、現在のコンポーネントを覚えておくような隠れたフィールドが存在するだけです。もっと言えば、パフォーマンス最適化のために <code class=\"language-text\">useState</code> には <a href=\"https://github.com/facebook/react/blob/2c4d61e1022ae383dd11fe237f6df8451e6f0310/packages/react-reconciler/src/ReactFiberHooks.js#L1260-L1290\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">マウント用と更新用</a>の実装が別れてすらいます。それでも、目を細めてみてください。一生懸命コードを眺めてみると、これが本質的にエフェクトハンドラであるように見えてくるかもしれませんよ。</p>\n<p>まとめると、JavaScript において <code class=\"language-text\">throw</code> することは IO エフェクトの大雑把な近似となります（コード自体が安全に再実行でき、かつ CPU バウンドでなければの話ですが）。そしてミュータブルな「ディスパッチャ」のフィールドを <code class=\"language-text\">try / finally</code> 内で復元することは、同期的なエフェクトハンドラの大雑把な近似となります。</p>\n<p>もっとずっと忠実に、エフェクトの実装を再現しようと思った場合は、<a href=\"https://dev.to/yelouafi/algebraic-effects-in-javascript-part-4---implementing-algebraic-effects-and-handlers-2703\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">ジェネレータを使えば</a>実現できます。しかしこうすると JavaScript の関数が持つ「透明な」性質を諦める必要があり、つまりすべてのものをジェネレータで書かないといけなくなります。それはちょっと……ねぇ。</p>\n<h3 id=\"もっと詳しく学びたい人は\"><a href=\"#%E3%82%82%E3%81%A3%E3%81%A8%E8%A9%B3%E3%81%97%E3%81%8F%E5%AD%A6%E3%81%B3%E3%81%9F%E3%81%84%E4%BA%BA%E3%81%AF\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>もっと詳しく学びたい人は</h3>\n<p>個人的には、Algebraic Effects がこんなにもすんなり理解できたことに驚きました。私はこれまで、例えばモナドのような抽象概念を理解するのに苦労してきたのですが、Algebraic Effects はただ「カチッと」ハマりました。この記事があなたにとってもカチッとハマる手助けになればと思います。</p>\n<p>これがメインストリームで採用されていくのかはわかりません。私としては、2025 年までにこれが流行っていなければがっかりするでしょうから、5 年後を楽しみにしていきたいですね！</p>\n<p>Algebraic Effects にできることはまだまだたくさんあると確信しています — しかし本当のパワーは実際にその方法でコードを書かないと、理解するのが難しいでしょう。この記事で興味を持った人は、気になりそうな資料をいくつか置いておきます。</p>\n<ul>\n<li><a href=\"https://github.com/ocamllabs/ocaml-effects-tutorial\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://github.com/ocamllabs/ocaml-effects-tutorial</a></li>\n<li><a href=\"https://www.janestreet.com/tech-talks/effective-programming/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.janestreet.com/tech-talks/effective-programming/</a></li>\n<li><a href=\"https://www.youtube.com/watch?v=hrBq8R_kxI0\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">https://www.youtube.com/watch?v=hrBq8R_kxI0</a></li>\n</ul>\n<p>また多くの人が指摘していましたが、型付けの側面を無視すれば（この記事でもそうしたように）、Common Lisp の <a href=\"https://en.wikibooks.org/wiki/Common_Lisp/Advanced_topics/Condition_System\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">コンディションシステム</a>を昔からの先行技術として挙げられます。James Long の<a href=\"https://jlongster.com/Whats-in-a-Continuation\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">継続についての記事</a>は、<code class=\"language-text\">call/cc</code> プリミティブがいかにして、ユーザーランドにおいて復帰できる例外を作るための土台になるかを説明しているので読んでみると面白いでしょう。</p>\n<p>Algebraic Effects について、JavaScript をバックグラウンドにした人向けの良さそうな資料を見つけた人は、ぜひとも Twitter で知らせてください！</p>","timeToRead":24,"frontmatter":{"title":"我々向けの Algebraic Effects 入門","date":"July 21, 2019","spoiler":"ブリトーとは違うんですよ","cta":null},"fields":{"slug":"/ja/algebraic-effects-for-the-rest-of-us/","langKey":"ja"}}},"pageContext":{"slug":"/ja/algebraic-effects-for-the-rest-of-us/","translations":["ja","ko","zh-hans"],"translatedLinks":["/things-i-dont-know-as-of-2018/","/how-does-setstate-know-what-to-do/"]}}}