{"componentChunkName":"component---src-templates-blog-post-js","path":"/fr/why-do-hooks-rely-on-call-order/","result":{"data":{"site":{"siteMetadata":{"title":"Overreacted","author":"Dan Abramov"}},"markdownRemark":{"id":"3ddef29d-c9aa-5537-a646-f860bd9dff79","html":"<p>Lors de la React Conf 2018, l’équipe de React a présenté notre <a href=\"https://reactjs.org/docs/hooks-intro.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">proposition de Hooks</a>.</p>\n<p>Si vous souhaitez comprendre ce que sont les Hooks et quels problèmes ils résolvent, jetez un œil à <a href=\"https://www.youtube.com/watch?v=dpw9EHDh2bM\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">nos présentations</a> qui sont une bonne introduction, ainsi que <a href=\"https://medium.com/@dan_abramov/making-sense-of-react-hooks-fdbde8803889\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">mon article complémentaire</a> qui traitait des principales fausses idées sur le sujet.</p>\n<p>Il est possible que votre réaction initiale aux Hooks soit négative :</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d498863e7382b4d5ee4d8753e6e74a1e/f868f/hooks-hn1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 19.594594594594593%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAYAAACOXx+WAAAACXBIWXMAABYlAAAWJQFJUiTwAAAA1UlEQVQY01VQ266CMBDk/7/oJB5UKNDW0yLwIDExIl4QOCRG/YBxd6MPPkxmOzubTibo+yO67gDm67UVHscTHo9/wfM5Cd/v4xez/gG/b7eeMCAwJkaaLhFFM8RxiCRZII5+ZV6tElijZK/UHDpbIgx/oDXfLJCSlz0Z6bvdBpfLHkFdF2LIcwNrFZzTWK8tqsqjLB3pFrnXdJjC0459Wkcoij+ZvcvgvUFdl5I+YNFQCmalQjFWlZNkTbPFNHX0c0O1NDif91RJK0m4poHqGd4VsYe9L/zQGSMpPy/HAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Commentaire HN négatif\"\n        title=\"\"\n        src=\"/static/d498863e7382b4d5ee4d8753e6e74a1e/fcda8/hooks-hn1.png\"\n        srcset=\"/static/d498863e7382b4d5ee4d8753e6e74a1e/12f09/hooks-hn1.png 148w,\n/static/d498863e7382b4d5ee4d8753e6e74a1e/e4a3f/hooks-hn1.png 295w,\n/static/d498863e7382b4d5ee4d8753e6e74a1e/fcda8/hooks-hn1.png 590w,\n/static/d498863e7382b4d5ee4d8753e6e74a1e/efc66/hooks-hn1.png 885w,\n/static/d498863e7382b4d5ee4d8753e6e74a1e/c83ae/hooks-hn1.png 1180w,\n/static/d498863e7382b4d5ee4d8753e6e74a1e/f868f/hooks-hn1.png 1382w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<blockquote class=\"translation\">« Ma réaction viscérale est que les Hooks ne sont pas une super idée pour React.  Un des trucs que j’ai toujours mis en avant au sujet de React est son API propre et extrêmement explicite (<code>dangerouslySetInnerHTML</code> étant mon exemple préféré).  L’API des Hooks emprunte un chemin dangereux vers plus d’implicite et de magie qui à mon sens ne peut avoir que de mauvaises conséquences. » <cite> NdT</cite></blockquote>\n<p>Ils sont un peu comme un morceau de musique qui vous envoute au bout de quelques écoutes :</p>\n<p>\n  <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/b31774c3ef4f2239bf9e62fe9272662b/1dbe8/hooks-hn2.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n  \n  <span\n    class=\"gatsby-resp-image-wrapper\"\n    style=\"position: relative; display: block;  max-width: 590px; margin-left: auto; margin-right: auto;\"\n  >\n    <span\n      class=\"gatsby-resp-image-background-image\"\n      style=\"padding-bottom: 23.64864864864865%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAABYlAAAWJQFJUiTwAAABBklEQVQY0z1Q2XKCQBDk//8nFcsCUwJyhuUIBEuFeKBERcHyeuzMTkIeunp7pmd7apTNpsB2+4W6XqGqSuIljscKl8uB0bbfzF13+OM91fb//d5zvTZ4PFooInAQChdCOHBdA75v8TsIbCRJgDj2WUeRR70JfG8Cx9ZJ+9wLaN5zTf6j3i2hSNEP9RyGLqLQowAT6YdgyKAsC3/D3m0OlD4ZwEuRv2l2UIbDF5jmG0bagNm2xtDUAcZjFbquEWswjBFU9RW6rBFkkOPosMhrUs+mjaV3vV5Amc8zrFZzTPMEeR5jNkuJE+aynKIociwWn6zTVOB0rvF8drjfzwx5t9vtxJB3/AEwKl21CwjATgAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n    >\n      <img\n        class=\"gatsby-resp-image-image\"\n        style=\"width: 100%; height: 100%; margin: 0; vertical-align: middle; position: absolute; top: 0; left: 0; box-shadow: inset 0px 0px 0px 400px white;\"\n        alt=\"Commentaire HN positif de la même personne, 4 jours plus tard\"\n        title=\"\"\n        src=\"/static/b31774c3ef4f2239bf9e62fe9272662b/fcda8/hooks-hn2.png\"\n        srcset=\"/static/b31774c3ef4f2239bf9e62fe9272662b/12f09/hooks-hn2.png 148w,\n/static/b31774c3ef4f2239bf9e62fe9272662b/e4a3f/hooks-hn2.png 295w,\n/static/b31774c3ef4f2239bf9e62fe9272662b/fcda8/hooks-hn2.png 590w,\n/static/b31774c3ef4f2239bf9e62fe9272662b/efc66/hooks-hn2.png 885w,\n/static/b31774c3ef4f2239bf9e62fe9272662b/c83ae/hooks-hn2.png 1180w,\n/static/b31774c3ef4f2239bf9e62fe9272662b/1dbe8/hooks-hn2.png 1374w\"\n        sizes=\"(max-width: 590px) 100vw, 590px\"\n      />\n    </span>\n  </span>\n  \n  </a>\n    </p>\n<blockquote class=\"translation\">« Après avoir bûché cette API ces 3 derniers jours et suivi les discussions dans la RFC, j’ai complètement revu ma position.  Je me suis dit que je ne pouvais pas laisser mon commentaire initial intact, parce qu’il ne reflète plus du tout mon opinion.  Je trouve les Hooks fabuleux. Si l’équipe de React arrive à une API impeccable, j’ai le sentiment que les Hooks vont révolutionner notre façon d’utiliser React.  J’ai toujours l’impression qu’ils élèveront un peu la barrière d’entrée, mais pour un développeur React expérimenté, ils sont fantastiques. » <cite>NdT</cite></blockquote>\n<p>Quand vous lirez les docs, ne loupez pas <a href=\"https://reactjs.org/docs/hooks-custom.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">la page la plus importante</a> qui parle de construire vos propres Hooks ! Trop de gens se focalisent sur une partie de notre message avec laquelle ils ne sont pas d’accord (ex. qu’apprendre les classes est difficile) et loupent la vision d’ensemble derrière les Hooks.  Et cette vision d’ensemble, c’est que  <strong>les Hooks sont comme des <em>mixins fonctionnels</em> qui vous permettent de créer et composer vos propres abstractions.</strong></p>\n<p>Les Hooks <a href=\"https://reactjs.org/docs/hooks-faq.html#what-is-the-prior-art-for-hooks\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">se sont inspirés de travaux antérieurs</a> mais je n’ai rien vu qui soit <em>vraiment</em> similaire jusqu’à ce que Sebastien partage son idée avec l’équipe.  Malheureusement, il est facile de ne pas prêter attention à la relation étroite entre des choix de conception spécifiques pour l’API et les avantages qui en découlent.  Avec cet article, j’espère aider davantage de personnes à comprendre la philosophie qui sous-tend l’aspect le plus controversé de la proposition des Hooks.</p>\n<p><strong>La suite de cet article suppose que vous connaissez l’API de Hooks <code class=\"language-text\">useState()</code> et avez lu comment écrire son propre Hook.  Si ce n’est pas le cas, suivez les liens ci-avant.  Par ailleurs, gardez à l’esprit que les Hooks sont encore expérimentaux et que vous n’avez pas besoin d’apprendre à vous en servir dès maintenant !</strong></p>\n<p>(Mise en garde : ceci est un article à moi, et ne reflète pas nécessairement les opinions de l’équipe React.  L’article est long, le sujet complexe, et je ne suis pas à l’abri d’avoir fait une erreur quelque part.)</p>\n<hr>\n<p>Le premier—et sans doute le plus grand—choc lorsque vous découvrez les Hooks est qu’ils exigent un <em>maintien de l’ordre des appels d’un rendu à l’autre</em>.  Ce qui n’est pas sans <a href=\"https://reactjs.org/docs/hooks-rules.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">conséquences</a>.</p>\n<p>Cette décision est évidemment controversée.  C’est pourquoi, <a href=\"https://www.reddit.com/r/reactjs/comments/9xs2r6/sebmarkbages_response_to_hooks_rfc_feedback/e9wh4um/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">contrairement à nos principes</a>, nous avons publié la proposition seulement une fois que nous estimions que la documentation et nos présentations faisaient un travail d’explication suffisamment bon pour que les gens lui donnent une chance.</p>\n<p><strong>Si vous avez des réserves sur certains aspects de la conception de l’API des Hooks, je ne saurais trop vous recommander la lecture de <a href=\"https://github.com/reactjs/rfcs/pull/68#issuecomment-439314884\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">la réponse détaillée</a> de Sebastian à la discussion RFC, qui dépasse les 1 300 commentaires.</strong>  Elle est très complète, mais aussi assez dense.  Je pourrais sans doute transformer chacun de ses paragraphes en un article dédié sur ce blog.  (En fait, je l’ai <a href=\"/how-does-setstate-know-what-to-do/\">déjà fait</a> une fois !)</p>\n<p>Aujourd’hui j’aimerais aborder un point particulier.  Comme vous vous en souvenez peut-être, chaque Hook peut être utilisé dans un composant plus d’une fois.  Par exemple, nous pouvons déclarer <a href=\"https://reactjs.org/docs/hooks-state.html#tip-using-multiple-state-variables\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">plusieurs variables d’état</a> en utilisant <code class=\"language-text\">useState()</code> à chaque fois :</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Form</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">,</span> setName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Mary'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>              <span class=\"token comment\">// Variable d’état 1</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>surname<span class=\"token punctuation\">,</span> setSurname<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Poppins'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>     <span class=\"token comment\">// Variable d’état 2</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> setWidth<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>innerWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Variable d’état 3</span></span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleResize</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setWidth</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>innerWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resize'</span><span class=\"token punctuation\">,</span> handleResize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resize'</span><span class=\"token punctuation\">,</span> handleResize<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">handleNameChange</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setName</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">function</span> <span class=\"token function\">handleSurnameChange</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token function\">setSurname</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>name<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>handleNameChange<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>surname<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>handleSurnameChange<span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Bonjour, </span><span class=\"token punctuation\">{</span>name<span class=\"token punctuation\">}</span><span class=\"token plain-text\"> </span><span class=\"token punctuation\">{</span>surname<span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">La fenêtre fait </span><span class=\"token punctuation\">{</span>width<span class=\"token punctuation\">}</span><span class=\"token plain-text\"> de large</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Remarquez que nous utilisons la syntaxe de déstructuration positionnelle pour nommer les variables d’état issues de <code class=\"language-text\">useState()</code>, mais que ces noms ne sont pas passés à React.  Au lieu de ça, dans cet exemple <strong>React traite <code class=\"language-text\">name</code> comme « la première variable d’état », <code class=\"language-text\">surname</code> comme « la deuxième variable d’état », et ainsi de suite</strong>. Leur <em>position d’appel</em> est ce qui leur confère une identité stable d’un rendu à l’autre.  Ce modèle mental est bien décrit <a href=\"https://medium.com/@ryardley/react-hooks-not-magic-just-arrays-cd4f1857236e\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">dans cet article</a>.</p>\n<p>En surface, se reposer sur l’ordre d’appel <em>ne sent pas bon</em>.  Une telle sensation est certes un signal utile, mais elle peut être erronée—surtout si nous n’avons pas encore complètement internalisé le problème que nous sommes en train de résoudre. <strong>Dans cet article, je vais examiner quelques approches alternatives qui ont été suggérées pour les Hooks, et expliquer pourquoi elles ne fonctionnent pas.</strong></p>\n<hr>\n<p>Cet article ne sera pas exhaustif.  Selon la granularité que vous employez pour les distinguer, on a vu entre une douzaine et des <em>centaines</em> de propositions alternatives distinctes.  Nous aussi, nous avons <a href=\"https://github.com/reactjs/react-future\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">réfléchi</a> à des APIs alternatives de composant ces cinq dernières années.</p>\n<p>Des articles comme celui-ci sont délicats parce que même si vous couvrez une centaine d’alternatives, quelqu’un en retouchera légèrement une et dira : « Ah, tu n’avais pas pensé à <em>ça</em> ! »</p>\n<p>En pratique, des alternatives différentes ont tendance à se recouper dans leurs inconvénients.  Plutôt que d’énumérer <em>toutes</em> les APIs suggérées (ce qui me prendrait des mois), je vais illustrer leurs défauts les plus courants à l’aide d’exemples précis.  Quant à catégoriser les autres APIs possibles à l’aide de ces failles, je le laisse en exercice aux lecteurs, comme dirait l’autre.</p>\n<p><em>Ça ne veut pas dire que les Hooks sont sans défaut.</em> Mais une fois que vous aurez assimilé les failles des autres solutions, vous vous direz peut-être que la conception des Hooks a du sens.</p>\n<hr>\n<h3 id=\"défaut-n°1--impossible-dextraire-un-hook-personnalisé\"><a href=\"#d%C3%A9faut-n%C2%B01--impossible-dextraire-un-hook-personnalis%C3%A9\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Défaut n°1 : Impossible d’extraire un Hook personnalisé</h3>\n<p>Cela nous a surpris, mais de nombreuses propositions alternatives ne permettent pas du tout de faire des <a href=\"https://reactjs.org/docs/hooks-custom.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Hooks personnalisés</a>.  Peut-être n’avons-nous pas mis suffisamment ces derniers en avant dans les docs « Motifs ».   C’est difficile à faire tant que les primitives des Hooks ne sont pas bien comprises.  C’est un peu le problème de l’œuf et la poule.  Mais les Hooks personnalisés sont au cœur de notre proposition.</p>\n<p>Par exemple, une alternative bannissait les appels multiples à <code class=\"language-text\">useState()</code> dans un composant.  On devait conserver l’état dans un objet unique.  Ça marche pour les classes, non ?</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Form</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    name<span class=\"token operator\">:</span> <span class=\"token string\">'Mary'</span><span class=\"token punctuation\">,</span>\n    surname<span class=\"token operator\">:</span> <span class=\"token string\">'Poppins'</span><span class=\"token punctuation\">,</span>\n    width<span class=\"token operator\">:</span> window<span class=\"token punctuation\">.</span>innerWidth<span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Soyons clairs: les Hooks <em>autorisent</em> ce style.  Vous n’êtes pas <em>obligés</em> de découper votre état en plusieurs variables (comme en témoignent les <a href=\"https://reactjs.org/docs/hooks-faq.html#should-i-use-one-or-many-state-variables\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">recommandations</a> de la FAQ).</p>\n<p>Mais l’idée derrière la possibilité d’appels multiples à <code class=\"language-text\">useState()</code>, c’est qu’on puisse <em>extraire</em> des parties de la logique à état (état + effets) hors de vos composants vers des Hooks personnalisés qui pourront <em>aussi</em> utiliser de façon indépendante l’état local et les effets :</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Form</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Déclarons quelques variables d’état directement dans le corps de composant</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">,</span> setName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Mary'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>surname<span class=\"token punctuation\">,</span> setSurname<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Poppins'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// On a sorti une partie de l’état et des effets dans un Hook personnalisé</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> width <span class=\"token operator\">=</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// Déclarons quelques variables d’état directement dans un Hook personnalisé</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> setWidth<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>window<span class=\"token punctuation\">.</span>innerWidth<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> width<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Si vous n’autorisez qu’un appel à <code class=\"language-text\">useState()</code> par composant, vous perdez la possibilité pour les Hooks personnalisés d’introduire de l’état local.  Ce qui est pourtant l’essence des Hooks personnalisés.</p>\n<h3 id=\"défaut-n°2--conflits-de-nommage\"><a href=\"#d%C3%A9faut-n%C2%B02--conflits-de-nommage\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Défaut n°2 : Conflits de nommage</h3>\n<p>Une suggestion fréquente consiste à ce que <code class=\"language-text\">useState()</code> accepte un argument de clé (ex. une chaîne) qui identifierait de façon unique la variable d’état au sein du composant.</p>\n<p>On trouve diverses variations de cette idée, mais ça ressemble toujours plus ou moins à ça :</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// ⚠️ Ceci n’est PAS l’API de Hooks de React</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Form</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// On passerait une sorte de clé d’état à useState()</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">,</span> setName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>surname<span class=\"token punctuation\">,</span> setSurname<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'surname'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> setWidth<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'width'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span></code></pre></div>\n<p>On tente ainsi de cesser de dépendre de l’ordre des appels (ouais, des clés explicites !) mais on amène un autre problème : les conflits de nommage.</p>\n<p>D’accord, vous ne serez sans doute pas tentés d’appeler <code class=\"language-text\">useState(&#39;name&#39;)</code> deux fois dans le même composant, sauf par erreur.  Ça pourrait arriver par accident, ce qui est vrai pour n’importe quel bug.  Néanmoins, il est beaucoup plus probable que lorsque vous travaillez sur un <em>Hook personnalisé</em>, vous souhaitiez ajouter ou retirer des variables d’état et des effets.</p>\n<p>Avec ce type de proposition, chaque fois que vous ajoutez une variable d’état dans un Hook personnalisé, vous risquez de casser les composants qui vous utilisent (directement ou transitivement) <em>parce qu’ils utilisent peut-être déjà le même nom</em> dans leurs propres variables d’état.</p>\n<p>C’est l’exemple même d’une API qui n’est pas <a href=\"/optimized-for-change/\">optimisée pour le changement</a>. Le code actuel semble peut-être « élégant », mais il réagirait mal à des changements de specs pour votre application. Ce serait bien qu’on <a href=\"https://reactjs.org/blog/2016/07/13/mixins-considered-harmful.html#mixins-cause-name-clashes\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">apprenne</a> de nos erreurs.</p>\n<p>La proposition officielle pour les Hooks résout ce problème en utilisant plutôt l’ordre d’appel : même si deux Hooks utilisent une variable d’état <code class=\"language-text\">name</code>, elles seront isolées l’une de l’autre.  Chaque appel à <code class=\"language-text\">useState()</code> obtient sa propre « cellule mémoire ».</p>\n<p>Il y a quelques autres manières de contourner ce défaut, mais elles ont toutes leurs propres soucis.  Explorons ce sujet d’un peu plus près.</p>\n<h3 id=\"défaut-n°3--impossible-dappeler-le-même-hook-deux-fois\"><a href=\"#d%C3%A9faut-n%C2%B03--impossible-dappeler-le-m%C3%AAme-hook-deux-fois\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Défaut n°3 : Impossible d’appeler le même Hook deux fois</h3>\n<p>Une autre variation de l’approche « par clé » de <code class=\"language-text\">useState</code> consiste à utiliser quelque chose comme les Symboles. Ceux-ci empêchent les conflits, pas vrai ?</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// ⚠️ Ceci n’est PAS l’API de Hooks de React</span>\n<span class=\"token keyword\">const</span> nameKey <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> surnameKey <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> widthKey <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">Form</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// On passerait une sorte de clé d’état à useState()</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">,</span> setName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>nameKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>surname<span class=\"token punctuation\">,</span> setSurname<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>surnameKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> setWidth<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>widthKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token comment\">// ...</span></code></pre></div>\n<p>Cette approche semble fonctionner pour extraire le Hook <code class=\"language-text\">useWindowWidth</code> :</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// ⚠️ Ceci n’est PAS l’API de Hooks de React</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Form</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> width <span class=\"token operator\">=</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/*********************\n * useWindowWidth.js *\n ********************/</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> widthKey <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>width<span class=\"token punctuation\">,</span> setWidth<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>widthKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// ...</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> width<span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>Mais si on essaie d’extraire la gestion de saisie, ça échouerait :</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// ⚠️ Ceci n’est PAS l’API de Hooks de React</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Form</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> <span class=\"token function\">useFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> surname <span class=\"token operator\">=</span> <span class=\"token function\">useFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token comment\">// ...</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">...</span><span class=\"token attr-value\">name</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">...</span><span class=\"token attr-value\">surname</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token punctuation\">{</span><span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token comment\">/*******************\n * useFormInput.js *\n ******************/</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> valueKey <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">useFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> setValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>valueKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    value<span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token function\">onChange</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token punctuation\">}</span></span></code></pre></div>\n<p>(Je vous accorde que ce Hook <code class=\"language-text\">useFormInput()</code> n’est pas super utile, mais on pourrait imaginer qu’il gère des trucs comme la validation ou un drapeau de modification, façon <a href=\"https://github.com/jaredpalmer/formik\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Formik</a>.)</p>\n<p>Vous avez repéré le bug ?</p>\n<p>On appelle <code class=\"language-text\">useFormInput()</code> deux fois, mais notre <code class=\"language-text\">useFormInput()</code> appelle toujours <code class=\"language-text\">useState()</code> avec la même clé.  En pratique, on fait ceci :</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>name<span class=\"token punctuation\">,</span> setName<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>valueKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>surname<span class=\"token punctuation\">,</span> setSurname<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>valueKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Et hop, re-conflit.</p>\n<p>La proposition officielle pour les Hooks n’a pas ce problème parce que <strong>chaque <em>appel</em> à <code class=\"language-text\">useState()</code> obtient son propre état isolé.</strong>  Se baser sur une position d’appel stable nous libère des soucis de conflit de nommage.</p>\n<h3 id=\"défaut-n°4--le-problème-du-diamant\"><a href=\"#d%C3%A9faut-n%C2%B04--le-probl%C3%A8me-du-diamant\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Défaut n°4 : Le problème du Diamant</h3>\n<p>Techniquement c’est le même défaut que juste avant, mais il mérite d’être mentionné à part en raison de sa célébrité.  Il est même <a href=\"https://fr.wikipedia.org/wiki/Probl%C3%A8me_du_diamant\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">décrit dans Wikipedia</a>. (Apparemment, on l’appelle aussi « Diamant mortel de la mort » — pas mal.)</p>\n<p>Notre propre système de mixins <a href=\"https://reactjs.org/blog/2016/07/13/mixins-considered-harmful.html#mixins-cause-name-clashes\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">en souffrait</a>.</p>\n<p>Deux Hooks personnalisés comme <code class=\"language-text\">useWindowWidth()</code> et <code class=\"language-text\">useNetworkStatus()</code> pourraient vouloir utiliser le même Hook personnalisé genre <code class=\"language-text\">useSubscription()</code> sous le capot :</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">StatusMessage</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> width <span class=\"token operator\">=</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> isOnline <span class=\"token operator\">=</span> <span class=\"token function\">useNetworkStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">La fenêtre fait </span><span class=\"token punctuation\">{</span>width<span class=\"token punctuation\">}</span><span class=\"token plain-text\"> de large</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\">Vous êtes </span><span class=\"token punctuation\">{</span>isOnline <span class=\"token operator\">?</span> <span class=\"token string\">'en ligne'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'hors-ligne'</span><span class=\"token punctuation\">}</span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">useSubscription</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">subscribe<span class=\"token punctuation\">,</span> unsubscribe<span class=\"token punctuation\">,</span> getValue</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span>  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>state<span class=\"token punctuation\">,</span> setState<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleChange</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setState</span><span class=\"token punctuation\">(</span><span class=\"token function\">getValue</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">subscribe</span><span class=\"token punctuation\">(</span>handleChange<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">unsubscribe</span><span class=\"token punctuation\">(</span>handleChange<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> state<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useWindowWidth</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> width <span class=\"token operator\">=</span> <span class=\"token function\">useSubscription</span><span class=\"token punctuation\">(</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token parameter\">handler</span> <span class=\"token operator\">=></span> window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resize'</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token parameter\">handler</span> <span class=\"token operator\">=></span> window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'resize'</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> window<span class=\"token punctuation\">.</span>innerWidth</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token keyword\">return</span> width<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useNetworkStatus</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> isOnline <span class=\"token operator\">=</span> <span class=\"token function\">useSubscription</span><span class=\"token punctuation\">(</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token parameter\">handler</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'online'</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      window<span class=\"token punctuation\">.</span><span class=\"token function\">addEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'offline'</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token parameter\">handler</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'online'</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      window<span class=\"token punctuation\">.</span><span class=\"token function\">removeEventListener</span><span class=\"token punctuation\">(</span><span class=\"token string\">'offline'</span><span class=\"token punctuation\">,</span> handler<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> navigator<span class=\"token punctuation\">.</span>onLine</span><span class=\"gatsby-highlight-code-line\">  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token keyword\">return</span> isOnline<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>C’est un cas d’utilisation totalement légitime. <strong>Il devrait être sans danger pour l’auteur d’un Hook personnalisé de commencer ou de cesser d’utiliser un autre Hook personnalisé sans avoir à se soucier du fait qu’il serait « déjà utilisé » ailleurs dans la chaîne.</strong> En fait, <em>on ne peut jamais connaître</em> la chaîne complète à moins d’auditer chaque composant utilisant notre Hook, chaque fois qu’on le modifie.</p>\n<p>(À titre de contre-exemple, les mixins historiques <code class=\"language-text\">createClass()</code> de React ne vous permettaient pas de faire ça. Il pouvait arriver que vous ayez deux mixins qui faisaient chacun exactement ce dont vous aviez besoin mais étaient mutuellement incompatibles parce qu’ils étendait le même « mixin de base ».)</p>\n<p>Voici notre « diamant » : 💎</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">       / useWindowWidth()   \\                   / useState()  🔴 Clash\nStatus                        useSubscription()\n       \\ useNetworkStatus() /                   \\ useEffect() 🔴 Clash</code></pre></div>\n<p>En nous basant sur l’ordre d’appel, le problème disparaît naturellement :</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">                                                 / useState()  ✅ #1. État\n       / useWindowWidth()   -&gt; useSubscription()\n      /                                          \\ useEffect() ✅ #2. Effet\nStatus\n      \\                                          / useState()  ✅ #3. État\n       \\ useNetworkStatus() -&gt; useSubscription()\n                                                 \\ useEffect() ✅ #4. Effet</code></pre></div>\n<p>Les appels de fonctions n’ont pas de problème de « diamant » parce qu’elles forment plutôt un arbre. 🎄</p>\n<h3 id=\"défaut-n°5--le-copier-coller-casse-des-trucs\"><a href=\"#d%C3%A9faut-n%C2%B05--le-copier-coller-casse-des-trucs\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Défaut n°5 : Le copier-coller casse des trucs</h3>\n<p>On pourrait peut-être sauver la proposition à base de clés en introduisant une sorte d’espace de noms.  Il y a plusieurs manières de s’y prendre.</p>\n<p>Une première façon consisterait à isoler les clés d’état dans des fermetures lexicales (<em>closures</em>).  Cela nécessiterait qu’on « instancie » les Hooks personnalisés et qu’on ajoute donc une fonction d’enrobage autour de chacun d’eux :</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">/*******************\n * useFormInput.js *\n ******************/</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">createUseFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token comment\">// Unique par « instanciation »</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> valueKey <span class=\"token operator\">=</span> <span class=\"token function\">Symbol</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token function\">useFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> setValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span>valueKey<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n      value<span class=\"token punctuation\">,</span>\n      <span class=\"token function\">onChange</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Cette approche est plutôt lourde.  Un des objectifs de conception des Hooks était justement d’éviter le style fonctionnel fortement imbriqué qui domine les composants d’ordre supérieur (HOC) et les <em>render props</em>.  Ici, on doit « instancier » <em>n’importe quel</em> Hook avant de nous en servir—et utiliser la fonction résultat <em>une seule fois</em> dans le corps du composant.  Ce n’est pas tellement plus simple que de devoir appeler les hooks inconditionnellement.</p>\n<p>Qui plus est, on devrait répéter chaque Hook personnalisé utilisé par un composant : une première fois au niveau racine (ou dans la portée de la fonction si on écrit un Hook personnalisé), et une seconde fois à l’emplacement effectif d’appel.  Ça signifie qu’il vous faudrait jongler entre le rendu et la déclaration racine même pour de petites modifications :</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// ⚠️ Ceci n’est PAS l’API de Hooks de React</span>\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> useNameFormInput <span class=\"token operator\">=</span> <span class=\"token function\">createUseFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">const</span> useSurnameFormInput <span class=\"token operator\">=</span> <span class=\"token function\">createUseFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Form</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> <span class=\"token function\">useNameFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> surname <span class=\"token operator\">=</span> <span class=\"token function\">useNameFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token comment\">// ...</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Il faudrait aussi faire preuve de beaucoup de rigueur dans le nommage.  On aurait toujours « deux niveaux » de noms—les <em>factories</em> comme <code class=\"language-text\">createUseFormInput</code> et les Hooks instanciés comme <code class=\"language-text\">useNameFormInput</code> et <code class=\"language-text\">useSurnameFormInput</code>.</p>\n<p>Si vous appeliez la même « instance » de Hook personnalisé deux fois, vous auriez un conflit d’état.  En fait, le code ci-dessus fait cette erreur, vous l’aviez remarqué ? Ce devrait être :</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">  <span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> <span class=\"token function\">useNameFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> surname <span class=\"token operator\">=</span> <span class=\"token function\">useSurnameFormInput</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span> <span class=\"token comment\">// Et non useNameFormInput !</span></code></pre></div>\n<p>Ces problèmes ne sont pas insurmontables mais j’estime qu’ils ajoutent <em>plus</em> de friction que de simplement suivre les <a href=\"https://reactjs.org/docs/hooks-rules.html\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Règles des Hooks</a>.</p>\n<p>Point tout aussi important, cette approche enfreint les attentes qu’on a du copier-coller.  Extraire un Hook personnalisé sans l’enrobage de fermeture lexicale <em>continue à marcher</em> avec cette approche, mais seulement jusqu’à ce qu’on l’appelle deux fois. (À partir de quoi un conflit émerge.)  Il est désolant qu’une API qui semble marcher nous force soudain à Enrober Tout Partout™ lorsqu’on réalise qu’un conflit est survenu quelque part au fin fond de la chaîne.</p>\n<h3 id=\"défaut-n°6--on-a-toujours-besoin-dun-linter\"><a href=\"#d%C3%A9faut-n%C2%B06--on-a-toujours-besoin-dun-linter\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Défaut n°6 : On a toujours besoin d’un <em>linter</em></h3>\n<p>Il existe une autre façon d’éviter les conflits dus à un état géré par clés.  Si vous la connaissez, vous deviez commencer à fulminer que je n’en aie pas encore parlé ! Désolé.</p>\n<p>L’idée serait de <em>composer</em> les clés chaque fois qu’on écrit un Hook personnalisé.  Quelque chose comme ça :</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// ⚠️ Ceci n’est PAS l’API de Hooks de React</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Form</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token comment\">// ...</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> name <span class=\"token operator\">=</span> <span class=\"token function\">useFormInput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> surname <span class=\"token operator\">=</span> <span class=\"token function\">useFormInput</span><span class=\"token punctuation\">(</span><span class=\"token string\">'surname'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token comment\">// ...</span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">...</span><span class=\"token attr-value\">name</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>input</span> <span class=\"token spread\"><span class=\"token punctuation\">{</span><span class=\"token punctuation\">...</span><span class=\"token attr-value\">surname</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token punctuation\">{</span><span class=\"token comment\">/* ... */</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"gatsby-highlight-code-line\"><span class=\"token keyword\">function</span> <span class=\"token function\">useFormInput</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">formInputKey</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>value<span class=\"token punctuation\">,</span> setValue<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'useFormInput('</span> <span class=\"token operator\">+</span> formInputKey <span class=\"token operator\">+</span> <span class=\"token string\">').value'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">{</span>\n    value<span class=\"token punctuation\">,</span>\n    <span class=\"token function\">onChange</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">e</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token function\">setValue</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>De toutes les alternatives proposées, c’est celle qui me dérange le moins.  Mais je ne pense quand même pas qu’elle vaille le coup.</p>\n<p>Du code qui passerait des clés non-uniques ou mal composées <em>tomberait en marche</em> jusqu’à ce qu’un Hook soit appelé plusieurs fois, ou entre en conflit avec un autre Hook.  Pire, si c’est censé permettre l’appel conditionnel (après tout, on essaie de « corriger » l’exigence d’appel inconditionnel, non ?), on ne pourrait détecter ces conflits que tardivement.</p>\n<p>Devoir se rappeler de passer des clés à travers chaque couche de Hooks personnalisés semble suffisamment fragile pour que je veuille avoir un <em>linter</em> pour ça.  Ce qui ajouterait du travail à l’exécution (n’oubliez pas qu’elles sont censées servir <em>de clés</em>), et chaque fois ce sont quelques grammes supplémentaires dans le poids du bundle final. <strong>Mais si on doit <em>linter</em> de toutes façons, quel problème a-t-on résolu ?</strong></p>\n<p>Ça pourrait avoir du sens si la déclaration conditionnelle d’état et d’effets était vraiment souhaitable.  Mais en pratique, je la trouve plutôt gênante.  Je n’ai pas souvenir de qui que ce soit ayant jamais demandé à définir conditionnellement <code class=\"language-text\">this.state</code> ou <code class=\"language-text\">componentDidMount</code>, d’ailleurs.</p>\n<p>Selon vous, que signifie le code ci-dessous ?</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// ⚠️ Ceci n’est PAS l’API de Hooks de React</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">.</span>isActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'count'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">        </span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Est-ce que <code class=\"language-text\">count</code> est préservé quand <code class=\"language-text\">props.isActive</code> est <code class=\"language-text\">false</code> ?  Ou alors, est-il réinitialisé parce que <code class=\"language-text\">useState(&#39;count&#39;)</code> n’a pas été appelée ?</p>\n<p>Si un état conditionnel est préservé, qu’en est-il d’un effet ?</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// ⚠️ Ceci n’est PAS l’API de Hooks de React</span>\n<span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">.</span>isActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>count<span class=\"token punctuation\">,</span> setCount<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token string\">'count'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">    <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">const</span> id <span class=\"token operator\">=</span> <span class=\"token function\">setInterval</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">c</span> <span class=\"token operator\">=></span> c <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">      <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">clearInterval</span><span class=\"token punctuation\">(</span>id<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n      <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>p</span> <span class=\"token attr-name\">onClick</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setCount</span><span class=\"token punctuation\">(</span>count <span class=\"token operator\">+</span> <span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">        </span><span class=\"token punctuation\">{</span>count<span class=\"token punctuation\">}</span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>p</span><span class=\"token punctuation\">></span></span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Il ne peut clairement pas s’exécuter <em>avant</em> que <code class=\"language-text\">props.isActive</code> soit à <code class=\"language-text\">true</code> pour la première fois. Mais une fois qu’elle devient <code class=\"language-text\">true</code>, l’effet s’arrête-t-il jamais de tourner ?  Le <em>timer</em> périodique doit-il être annulé quand <code class=\"language-text\">props.isActive</code> passe à <code class=\"language-text\">false</code> ?  Si tel est le cas, ce serait déroutant qu’un effet se comporte différemment de l’état (dont on a dit qu’il était préservé).  Mais si l’effet continue, il est déroutant que le <code class=\"language-text\">if</code> qui entoure l’effet ne le rende plus conditionnel.  L’idée n’était-elle pas d’avoir des effets conditionnels ?</p>\n<p>Et si l’état <em>est</em> réinitialisé quand on ne « l’utilise » pas lors d’un rendu, que se passerait-il si plusieurs branches de <code class=\"language-text\">if</code> contiennent un <code class=\"language-text\">useState(&#39;count&#39;)</code>, mais que seule l’une d’elles s’exécute à un instant donné ? Serait-ce un code valide ? Si notre modèle mental est une « table de correspondances à base de clés », pourquoi des trucs « disparaîtraient » à l’intérieur ? La développeuse s’attendrait-elle à ce qu’un <code class=\"language-text\">return</code> de court-circuit dans le composant réinitialise tous les états utilisés plus loin ?  Si on voulait vraiment réinitialiser l’état, on pourrait être explicites en extrayant un composant :</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">Counter</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">props</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>props<span class=\"token punctuation\">.</span>isActive<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// Là, on a clairement un état qui lui est propre</span>\n    <span class=\"token keyword\">return</span> <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">TickingCounter</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>De toutes façons, ça deviendrait probablement une « meilleure pratique » pour éviter ces questions dérangeantes. Ainsi, peu importe comment vous décidez de les traiter, je pense que les aspects sémantiques de la <em>déclaration</em> conditionnelle d’état et d’effets apporte intrinsèquement des comportements si bizarres que vous voudriez <em>linter</em> pour les empêcher.</p>\n<p>Et si on doit <em>linter</em>, l’exigence de composition correcte des clés devient un « poids mort ».  Elle ne nous apporte rien que nous <em>voulions</em> vraiment.  En revanche, abandonner cette exigence (et revenir à la proposition officielle) <em>nous apporte bien</em> quelque chose.  Elle permet de copier-coller en confiance du code de composant vers un Hook personnalisé, sans avoir à recourir à un espace de noms ; elle réduit la taille du bundle en supprimant le besoin de clés ; et elle ouvre la voie à une implémentation légèrement plus performante (pas besoin de lookups dans une Map).</p>\n<p>Ce sont des petits gestes qui comptent.</p>\n<h3 id=\"défaut-n°7--impossible-de-passer-des-valeurs-entre-les-hooks\"><a href=\"#d%C3%A9faut-n%C2%B07--impossible-de-passer-des-valeurs-entre-les-hooks\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Défaut n°7 : Impossible de passer des valeurs entre les Hooks</h3>\n<p>Un des plus grands avantages des Hooks est qu’on peut aisément passer des valeurs entre eux.</p>\n<p>Voici un exemple hypothétique de choix d’un destinataire de message qui affiche l’état en ligne de la personne sélectionnée :</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">const</span> friendList <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'Phoebe'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">2</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'Rachel'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token punctuation\">{</span> id<span class=\"token operator\">:</span> <span class=\"token number\">3</span><span class=\"token punctuation\">,</span> name<span class=\"token operator\">:</span> <span class=\"token string\">'Ross'</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">ChatRecipientPicker</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>recipientID<span class=\"token punctuation\">,</span> setRecipientID<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span><span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> isRecipientOnline <span class=\"token operator\">=</span> <span class=\"token function\">useFriendStatus</span><span class=\"token punctuation\">(</span>recipientID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span>\n  <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span>\n    <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span><span class=\"token class-name\">Circle</span></span> <span class=\"token attr-name\">color</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>isRecipientOnline <span class=\"token operator\">?</span> <span class=\"token string\">'green'</span> <span class=\"token operator\">:</span> <span class=\"token string\">'red'</span><span class=\"token punctuation\">}</span></span> <span class=\"token punctuation\">/></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>select</span>\n        <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>recipientID<span class=\"token punctuation\">}</span></span>\n        <span class=\"token attr-name\">onChange</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span><span class=\"token parameter\">e</span> <span class=\"token operator\">=></span> <span class=\"token function\">setRecipientID</span><span class=\"token punctuation\">(</span><span class=\"token function\">Number</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>target<span class=\"token punctuation\">.</span>value<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span></span>\n      <span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">        </span><span class=\"token punctuation\">{</span>friendList<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">friend</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">(</span>\n          <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>option</span> <span class=\"token attr-name\">key</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>friend<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span> <span class=\"token attr-name\">value</span><span class=\"token script language-javascript\"><span class=\"token script-punctuation punctuation\">=</span><span class=\"token punctuation\">{</span>friend<span class=\"token punctuation\">.</span>id<span class=\"token punctuation\">}</span></span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">            </span><span class=\"token punctuation\">{</span>friend<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">}</span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">          </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>option</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">      </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>select</span><span class=\"token punctuation\">></span></span><span class=\"token plain-text\"></span>\n<span class=\"token plain-text\">    </span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span></span><span class=\"token punctuation\">></span></span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">function</span> <span class=\"token function\">useFriendStatus</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">friendID</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>isOnline<span class=\"token punctuation\">,</span> setIsOnline<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">null</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token function-variable function\">handleStatusChange</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">status</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token function\">setIsOnline</span><span class=\"token punctuation\">(</span>status<span class=\"token punctuation\">.</span>isOnline<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token function\">useEffect</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    ChatAPI<span class=\"token punctuation\">.</span><span class=\"token function\">subscribeToFriendStatus</span><span class=\"token punctuation\">(</span>friendID<span class=\"token punctuation\">,</span> handleStatusChange<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">return</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      ChatAPI<span class=\"token punctuation\">.</span><span class=\"token function\">unsubscribeFromFriendStatus</span><span class=\"token punctuation\">(</span>friendID<span class=\"token punctuation\">,</span> handleStatusChange<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> isOnline<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Quand on change le destinataire, notre Hook <code class=\"language-text\">useFriendStatus()</code> serait automatiquement désinscrit du statut de la personne précédente, et s’inscrirait à celui de la prochaine.</p>\n<p>Ça fonctionne parce qu’on peut passer la valeur de retour du Hook <code class=\"language-text\">useState()</code> au Hook <code class=\"language-text\">useFriendStatus()</code> :</p>\n<div class=\"gatsby-highlight has-highlighted-lines\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span>recipientID<span class=\"token punctuation\">,</span> setRecipientID<span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useState</span><span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"gatsby-highlight-code-line\">  <span class=\"token keyword\">const</span> isRecipientOnline <span class=\"token operator\">=</span> <span class=\"token function\">useFriendStatus</span><span class=\"token punctuation\">(</span>recipientID<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></span></code></pre></div>\n<p>Passer des valeurs entre les Hooks recèle une énorme puissance.  Par exemple, <a href=\"https://medium.com/@drcmda/hooks-in-react-spring-a-tutorial-c6c436ad7ee4\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">React Spring</a> vous permet de créer une séquence d’animations basée sur plusieurs valeurs qui se « suivent » l’une l’autre :</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\">  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> pos1 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">set</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> pos1<span class=\"token operator\">:</span> <span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">,</span> <span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> config<span class=\"token operator\">:</span> fast <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> pos2 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> pos2<span class=\"token operator\">:</span> pos1<span class=\"token punctuation\">,</span> config<span class=\"token operator\">:</span> slow <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">const</span> <span class=\"token punctuation\">[</span><span class=\"token punctuation\">{</span> pos3 <span class=\"token punctuation\">}</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token function\">useSpring</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> pos3<span class=\"token operator\">:</span> pos2<span class=\"token punctuation\">,</span> config<span class=\"token operator\">:</span> slow <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>(Voici une <a href=\"https://codesandbox.io/s/ppxnl191zx\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">démo</a>.)</p>\n<p>Les propositions qui placent l’initialisation des Hooks dans des valeurs par défaut d’arguments, ou qui écrivent les Hooks sous forme de décorateurs, rendent ce genre de logique difficile à exprimer.</p>\n<p>Si l’appel des Hooks ne se fait pas au sein de la fonction, on ne peut plus facilement passer des valeurs entre eux, ou transformer ces valeurs, sans ajouter plusieurs couches de composants, ou ajouter un <code class=\"language-text\">useMemo()</code> pour mettre en cache des calculs intermédiaires.  On ne peut pas non plus référencer facilement ces valeurs dans les effets parce qu’ils ne peuvent pas capturer les valeurs grâce à la fermeture lexicale (<em>closure</em>).  Il existe des moyens de contourner ces problèmes à l’aide de conventions, mais elles nous obligent à faire une « correspondance » mentale entre entrées et sorties.  C’est délicat, et en violation du style par ailleurs direct de React.</p>\n<p>Passer des valeurs entre les hooks est au cœur de notre proposition.  L’approche des <em>render props</em> était ce qui s’en rapprochait le plus sans les Hooks, mais on n’en tirait pas les pleins bénéfices qu’en recourant à quelque chose comme <a href=\"https://ui.reach.tech/component-component\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">Component Component</a>, ce qui amène beaucoup de bruit syntaxique en raison de sa « fausse hiérarchie ».  Les Hooks aplatissent la hiérarchie en passant les valeurs—et les appels de fonctions sont la manière la plus simple de le faire.</p>\n<h3 id=\"défaut-n°8--trop-de-formalisme\"><a href=\"#d%C3%A9faut-n%C2%B08--trop-de-formalisme\" aria-hidden class=\"anchor\"><svg aria-hidden=\"true\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Défaut n°8 : Trop de formalisme</h3>\n<p>Ce défaut se retrouve dans de nombreuses propositions.  La plupart tentent d’éviter une dépendance perçue des Hooks à React.  Les manières d’y arriver sont nombreuses : rendre les hooks prédéfinis accessibles via <code class=\"language-text\">this</code>, les passer comme argument supplémentaire à toutes les méthodes, etc.</p>\n<p>Je trouve que <a href=\"https://github.com/reactjs/rfcs/pull/68#issuecomment-439314884\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">la réponse de Sebastian</a> traite ce point beaucoup mieux que je ne pourrais le faire, alors je vous encourage à en lire la première section (<em>“Injection Model”</em>).</p>\n<p>Je me contenterai de dire ici que ce n’est pas sans raison que les programmeurs ont tendance à préférer <code class=\"language-text\">try</code> / <code class=\"language-text\">catch</code> plutôt que passer les codes d’erreur à travers chaque fonction de rappel lorsqu’il s’agit de gérer les erreurs. C’est pour la même raison qu’ils préfèrent les modules ES basés sur <code class=\"language-text\">import</code> (ou le <code class=\"language-text\">require</code> de CommonJS) aux définitions « explicites » d’AMD qui nous passent le <code class=\"language-text\">require</code> en argument.</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token comment\">// Y’a-t-il quelqu’un qui est nostalgique d’AMD ?</span>\n<span class=\"token function\">define</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token string\">'require'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'dependency1'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'dependency2'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">require</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">var</span> dependency1 <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dependency1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">var</span> dependency2 <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'dependency2'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">function</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Oui, AMD est peut-être plus « honnête » sur le fait que les modules ne sont pas chargés de façon synchrone par l’environnement du navigateur.  Mais une fois qu’on a compris ça, il est juste pénible d’avoir à écrire ce sandwich à base de <code class=\"language-text\">define</code> à chaque fois.</p>\n<p><code class=\"language-text\">try</code> / <code class=\"language-text\">catch</code>, <code class=\"language-text\">require</code>, et l’API de Contextes de React sont des exemples pragmatiques de situations où l’on souhaite avoir une gestion « déjà là » plutôt que d’avoir à la passer explicitement à travers chaque niveau de code—même si, en général, on préfère être explicites.  Je pense qu’il en va de même pour les Hooks.</p>\n<p>C’est un peu comme le fait que, lorsqu’on définit des composants, on choppe juste le <code class=\"language-text\">Component</code> depuis <code class=\"language-text\">React</code>.  Notre code serait sans doute plus découplé de React si on exportait à la place une factory pour chaque composant :</p>\n<div class=\"gatsby-highlight\" data-language=\"jsx\"><pre class=\"language-jsx\"><code class=\"language-jsx\"><span class=\"token keyword\">function</span> <span class=\"token function\">createModal</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">React</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">return</span> <span class=\"token keyword\">class</span> <span class=\"token class-name\">Modal</span> <span class=\"token keyword\">extends</span> <span class=\"token class-name\">React<span class=\"token punctuation\">.</span>Component</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token comment\">// ...</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<p>Mais en pratique, ça deviendrait juste une couche énervante d’indirection.  Le jour où on voudra effectivement remplacer React par autre chose, on pourra toujours plutôt le faire au niveau du systèmes de modules.</p>\n<p>C’est pareil pour les Hooks. Ceci dit, comme <a href=\"https://github.com/reactjs/rfcs/pull/68#issuecomment-439314884\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">la réponse de Sebastian</a> le mentionne, il est <em>techniquement possible</em> de « rediriger » les Hooks exportés par <code class=\"language-text\">react</code> vers une autre implémentation. (<a href=\"/how-does-setstate-know-what-to-do/\">Un de mes précédents articles</a> indique comment.)</p>\n<p>Une autre manière d’imposer trop de formalisme consisterait à rendre les Hooks <a href=\"https://paulgray.net/an-alternative-design-for-hooks/\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">monadiques</a> ou à ajouter un concept à part entière du genre <code class=\"language-text\">React.createHook()</code>. Le surcoût d’exécution mis à part, toute solution qui ajoute de l’enrobage nous fait perdre un des avantages majeurs des fonctions nues : <em>y’a pas plus simple à déboguer.</em></p>\n<p>Les fonctions nues vous laissent entrer et sortir avec un débogueur sans vous embourber dans du code intermédiaire de bibliothèque, et voir exactement comment les valeurs circulent dans le corps de votre composant.  Les indirections rendent cela difficile.  Les solutions d’esprit similaire aux composants d’ordre supérieurs (Hooks de style « décorateurs ») ou aux <em>render props</em> (ex. la proposition <code class=\"language-text\">adopt</code> ou le recours au <code class=\"language-text\">yield</code> des générateurs) souffrent du même problème.  Les indirections compliquent par ailleurs le typage statique.</p>\n<hr>\n<p>Comme je l’ai dit plus tôt, cet article n’ambitionne pas d’être exhaustif.  On trouve d’autres problèmes intéressants dans d’autres propositions.  Certains sont plus obscurs (ex. relatifs à la concurrence ou à des techniques de compilation avancées) et feront peut-être le sujet d’un autre article à l’avenir.</p>\n<p>Les Hooks ne sont pas non plus parfaits, mais ils constituent le meilleur compromis que nous avons pu trouver pour résoudre ces problèmes.  Il existe encore des choses que nous <a href=\"https://github.com/reactjs/rfcs/pull/68#issuecomment-440780509\" target=\"_blank\" rel=\"nofollow noopener noreferrer\">devons régler</a>, et il y a des choses qui sont plus malaisées à faire avec les Hooks qu’avec des classes.  Là aussi, c’est un sujet pour un autre article.</p>\n<p>Que j’aie ou non couvert votre proposition alternative préférée, j’espère que ce texte vous aura aidés à mieux comprendre notre processus de réflexion et les critères que nous examinons quand nous choisissons une API.  Comme vous pouvez le voir, de nombreux points (tels que la capacité à copier-coller en confiance, à déplacer du code, à ajouter ou retirer des dépendances) servent à <a href=\"/optimized-for-change/\">optimiser pour le changement</a>.  J’espère que les utilisateurs de React apprécieront ces aspects.</p>","timeToRead":25,"frontmatter":{"title":"Pourquoi les Hooks React dépendent-ils de l’ordre d’appel ?","date":"December 13, 2018","spoiler":"Les leçons que nous avons tirées des mixins, render props, HOCs et classes.","cta":null},"fields":{"slug":"/fr/why-do-hooks-rely-on-call-order/","langKey":"fr"}}},"pageContext":{"slug":"/fr/why-do-hooks-rely-on-call-order/","translations":["fr","es","zh-hans"],"translatedLinks":[]}}}